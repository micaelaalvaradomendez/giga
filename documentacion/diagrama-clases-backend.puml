@startuml Sistema_GIGA_Diagrama_Clases_Backend
!define RECTANGLE class

title Sistema GIGA - Diagrama de Clases Backend (Database First)\nEstructura Principal de Datos - 4 M√≥dulos Funcionales

' ==============================================================================
' ESTILOS Y CONFIGURACI√ìN
' ==============================================================================
skinparam backgroundColor #FFFFFF
skinparam handwritten false
skinparam monochrome false
skinparam shadowing false

skinparam class {
    BackgroundColor #E3F2FD
    BorderColor #1976D2
    FontSize 10
    AttributeFontSize 9
}

skinparam packageStyle rectangle
skinparam package {
    BackgroundColor #F5F5F5
    BorderColor #757575
    FontSize 12
}

' ==============================================================================
' M√ìDULO 1: PERSONAS (Estructura Organizacional)
' ==============================================================================
package "üìã M√ìDULO PERSONAS" #E8F5E8 {
    
    class Area {
        + id_area : BigAutoField <<PK>>
        + nombre : CharField(100)
        + descripcion : TextField
        + id_area_padre : ForeignKey(Area) <<nullable>>
        + jefe_area : ForeignKey(Agente) <<nullable>>
        + nivel : IntegerField
        + activo : BooleanField
        + creado_en : DateTimeField
        + actualizado_en : DateTimeField
        --
        + nombre_completo : Property
        + es_raiz : Property
        + total_agentes : Property
        + _obtener_ids_area_y_descendientes() : List
    }
    
    class Rol {
        + id_rol : BigAutoField <<PK>>
        + nombre : CharField(100) <<unique>>
        + descripcion : TextField
        + creado_en : DateTimeField
        + actualizado_en : DateTimeField
    }
    
    class Agente {
        + id_agente : BigAutoField <<PK>>
        + email : CharField(100) <<unique>>
        + dni : CharField(20) <<unique>>
        + cuil : CharField(20) <<unique>>
        + legajo : CharField(50) <<unique>>
        + nombre : CharField(100)
        + apellido : CharField(100)
        + password_hash : CharField(255)
        + telefono : CharField(15)
        + fecha_nacimiento : DateField
        + provincia : CharField(100)
        + ciudad : CharField(100)
        + calle : CharField(150)
        + numero : CharField(10)
        + horario_entrada : TimeField
        + horario_salida : TimeField
        + agrupacion : CharField(100)
        + activo : BooleanField
        + id_area : ForeignKey(Area)
        + creado_en : DateTimeField
        + actualizado_en : DateTimeField
        --
        + username : Property
        + direccion : Property
        + fecha_ingreso : Property
        + check_password(raw_password) : Boolean
        + set_password(raw_password) : void
    }
    
    class AgenteRol {
        + id_agente_rol : BigAutoField <<PK>>
        + id_agente : ForeignKey(Agente)
        + id_rol : ForeignKey(Rol)
        + asignado_en : DateTimeField
        + creado_en : DateTimeField
        + actualizado_en : DateTimeField
    }
    
    note right of Agente
        **Database First Strategy**
        ‚Ä¢ managed = False
        ‚Ä¢ Estructura definida en BD
        ‚Ä¢ Django solo CRUD datos
        ‚Ä¢ No puede modificar esquema
    end note
}

' ==============================================================================
' M√ìDULO 2: GUARDIAS (Cronogramas y Asignaciones)
' ==============================================================================
package "‚è∞ M√ìDULO GUARDIAS" #FFF3E0 {
    
    class Cronograma {
        + id_cronograma : BigAutoField <<PK>>
        + fecha_aprobacion : DateField
        + tipo : CharField(50)
        + hora_inicio : TimeField
        + hora_fin : TimeField
        + **estado : CharField(50)**
        + fecha_creacion : DateField
        + id_jefe : ForeignKey(Agente)
        + id_director : ForeignKey(Agente)
        + id_area : ForeignKey(Area)
        + creado_por_rol : CharField(50)
        + creado_por_id : ForeignKey(Agente)
        + aprobado_por_id : ForeignKey(Agente)
        + creado_en : DateTimeField
        + actualizado_en : DateTimeField
        --
        + requiere_aprobacion : Property
        + puede_aprobar_rol : Property
    }
    
    class Guardia {
        + id_guardia : BigAutoField <<PK>>
        + fecha : DateField
        + hora_inicio : TimeField
        + hora_fin : TimeField
        + observaciones : TextField
        + tipo : CharField(50)
        + activa : BooleanField
        + estado : CharField(50)
        + horas_planificadas : IntegerField
        + horas_efectivas : IntegerField
        + id_cronograma : ForeignKey(Cronograma)
        + id_agente : ForeignKey(Agente)
        + creado_en : DateTimeField
        + actualizado_en : DateTimeField
        --
        + es_multiples_dias : Property
        + fecha_fin_real : Property
        + duracion_dias : Property
        + incluye_fecha(fecha) : Boolean
        + get_fechas_incluidas() : List
    }
    
    class Feriado {
        + id_feriado : BigAutoField <<PK>>
        + nombre : CharField(200)
        + descripcion : TextField
        + fecha_inicio : DateField
        + fecha_fin : DateField
        + es_nacional : BooleanField
        + es_provincial : BooleanField
        + es_local : BooleanField
        + activo : BooleanField
        + creado_en : DateTimeField
        + actualizado_en : DateTimeField
        --
        + es_multiples_dias : Property
        + duracion_dias : Property
        + tipo_feriado : Property
        + incluye_fecha(fecha) : Boolean
    }
    
    note right of Cronograma
        **Campo Clave: estado**
        ‚Ä¢ 'borrador'
        ‚Ä¢ 'pendiente_aprobacion'
        ‚Ä¢ 'aprobado'
        ‚Ä¢ 'publicado'
        ‚Ä¢ 'rechazado'
        
        **Flujo de Aprobaci√≥n:**
        Jefatura ‚Üí Director ‚Üí Publicaci√≥n
        Administrador: Auto-aprobaci√≥n
    end note
}

' ==============================================================================
' M√ìDULO 3: ASISTENCIA (Marcaciones y Licencias)
' ==============================================================================
package "üìÖ M√ìDULO ASISTENCIA" #F3E5F5 {
    
    class Asistencia {
        + id_asistencia : BigAutoField <<PK>>
        + fecha : DateField
        + hora_entrada : TimeField
        + hora_salida : TimeField
        + marcacion_entrada_automatica : BooleanField
        + marcacion_salida_automatica : BooleanField
        + **es_correccion : BooleanField**
        + corregido_por : ForeignKey(Agente) <<nullable>>
        + observaciones : TextField
        + id_agente : ForeignKey(Agente)
        + id_area : ForeignKey(Area)
        + creado_en : DateTimeField
        + actualizado_en : DateTimeField
        --
        + estado : Property
    }
    
    class Licencia {
        + id_licencia : BigAutoField <<PK>>
        + **estado : CharField(50)**
        + fecha_desde : DateField
        + fecha_hasta : DateField
        + observaciones : TextField
        + justificacion : TextField
        + id_agente : ForeignKey(Agente)
        + id_tipo_licencia : ForeignKey(TipoLicencia)
        + aprobada_por : ForeignKey(Agente) <<nullable>>
        + fecha_aprobacion : DateField <<nullable>>
        + observaciones_aprobacion : TextField
        + rechazada_por : ForeignKey(Agente) <<nullable>>
        + fecha_rechazo : DateField <<nullable>>
        + motivo_rechazo : TextField
        + solicitada_por : ForeignKey(Agente) <<nullable>>
        + creado_en : DateTimeField
        + actualizado_en : DateTimeField
        --
        + dias_licencia : Property
    }
    
    class TipoLicencia {
        + id_tipo_licencia : BigAutoField <<PK>>
        + codigo : CharField(50) <<unique>>
        + descripcion : TextField
    }
    
    class IntentoMarcacionFraudulenta {
        + id_intento : BigAutoField <<PK>>
        + fecha : DateField
        + hora : TimeField
        + dni_ingresado : CharField(20)
        + tipo_intento : CharField(50)
        + ip_address : CharField(45)
        + id_agente_sesion : ForeignKey(Agente)
        + id_agente_dni : ForeignKey(Agente) <<nullable>>
        + creado_en : DateTimeField
    }
    
    note right of Asistencia
        **Campo Clave: es_correccion**
        ‚Ä¢ false: Marcaci√≥n normal
        ‚Ä¢ true: Correcci√≥n manual
        
        **Estados Calculados:**
        ‚Ä¢ 'completa': entrada + salida
        ‚Ä¢ 'sin_salida': solo entrada
        ‚Ä¢ 'sin_entrada': sin marcaciones
    end note
    
    note right of Licencia
        **Campo Clave: estado**
        ‚Ä¢ 'pendiente'
        ‚Ä¢ 'aprobada'
        ‚Ä¢ 'rechazada'
        
        **Flujo de Aprobaci√≥n:**
        Solicitud ‚Üí Jefe/Director ‚Üí Estado Final
    end note
}

' ==============================================================================
' M√ìDULO 4: AUDITOR√çA (Registro de Operaciones)
' ==============================================================================
package "üîç M√ìDULO AUDITOR√çA" #FFEBEE {
    
    class Auditoria {
        + id_auditoria : BigAutoField <<PK>>
        + pk_afectada : BigIntegerField <<nullable>>
        + nombre_tabla : CharField(100) <<nullable>>
        + **accion : CharField(50)**
        + valor_previo : JSONField <<nullable>>
        + valor_nuevo : JSONField <<nullable>>
        + id_agente : ForeignKey(Agente) <<nullable>>
        + creado_en : DateTimeField
        --
        + id : Property
    }
    
    note right of Auditoria
        **Campo Clave: accion**
        ‚Ä¢ 'CREATE' - Inserci√≥n
        ‚Ä¢ 'UPDATE' - Modificaci√≥n
        ‚Ä¢ 'DELETE' - Eliminaci√≥n
        ‚Ä¢ 'LOGIN' - Inicio sesi√≥n
        ‚Ä¢ 'LOGOUT' - Cierre sesi√≥n
        
        **Sin Relaciones Fuertes:**
        Solo referencial via pk_afectada
        Todos los cambios se registran
    end note
}

' ==============================================================================
' RELACIONES PRINCIPALES ENTRE M√ìDULOS
' ==============================================================================

' Relaciones Personas
Area ||--o{ Area : "jerarqu√≠a"
Area ||--o{ Agente : "pertenece"
Area ||--o| Agente : "jefe_area"
Agente ||--o{ AgenteRol : "tiene"
Rol ||--o{ AgenteRol : "asigna"

' Relaciones Guardias
Cronograma ||--o{ Guardia : "contiene"
Agente ||--o{ Guardia : "asignado"
Agente ||--o{ Cronograma : "jefe"
Agente ||--o{ Cronograma : "director"
Area ||--o{ Cronograma : "area"

' Relaciones Asistencia  
Agente ||--o{ Asistencia : "marca"
Agente ||--o{ Licencia : "solicita"
TipoLicencia ||--o{ Licencia : "tipo"
Area ||--o{ Asistencia : "area"
Agente ||--o{ IntentoMarcacionFraudulenta : "sesion"

' Relaciones Auditor√≠a (referenciales)
Agente ||..o{ Auditoria : "registra"

' ==============================================================================
' CARDINALIDADES Y RESTRICCIONES CLAVE
' ==============================================================================

note as cardinalidades
    **CARDINALIDADES IMPORTANTES:**
    
    **Personas:**
    ‚Ä¢ 1 Area ‚Üí N Agentes (pertenencia)
    ‚Ä¢ 1 Area ‚Üí 1 Agente (jefe_area) [opcional]
    ‚Ä¢ N Agente ‚Üí M Rol (via AgenteRol)
    
    **Guardias:**
    ‚Ä¢ 1 Cronograma ‚Üí N Guardias
    ‚Ä¢ 1 Agente ‚Üí N Guardias
    ‚Ä¢ 1 Area ‚Üí N Cronogramas
    
    **Asistencia:**
    ‚Ä¢ 1 Agente ‚Üí N Asistencias (unique por fecha)
    ‚Ä¢ 1 Agente ‚Üí N Licencias
    ‚Ä¢ 1 TipoLicencia ‚Üí N Licencias
    
    **Auditor√≠a:**
    ‚Ä¢ Sin FK estrictas, solo referencial
    ‚Ä¢ Todos los m√≥dulos generan auditor√≠a
end note

' ==============================================================================
' CONFIGURACI√ìN DATABASE FIRST
' ==============================================================================

note as database_first
    **ESTRATEGIA DATABASE FIRST:**
    
    **Todos los modelos:**
    ‚Ä¢ managed = False en Meta
    ‚Ä¢ Estructura definida en PostgreSQL
    ‚Ä¢ Django NO puede alterar esquemas
    ‚Ä¢ Scripts SQL en bd/init-scripts/
    
    **Beneficios:**
    ‚Ä¢ Control total de BD por DBA
    ‚Ä¢ Optimizaciones espec√≠ficas de PostgreSQL
    ‚Ä¢ Integridad referencial en BD
    ‚Ä¢ Django solo para CRUD y l√≥gica
    
    **Ubicaci√≥n Esquemas:**
    ‚Ä¢ /home/micaela/giga/bd/init-scripts/
    ‚Ä¢ Tablas: agente, area, rol, cronograma, 
      guardia, asistencia, licencia, auditoria
end note

@enduml