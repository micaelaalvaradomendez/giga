@startuml Flujo_Aprobacion_Cronograma_Jerarquico_GIGA
!define SEQUENCE_DIAGRAM

title Sistema GIGA - Diagrama de Secuencia\nAprobaciÃ³n de Cronograma: Flujo JerÃ¡rquico\nJefatura (Planifica) â†’ Director (Aprueba/Rechaza)

' ==============================================================================
' ACTORES Y PARTICIPANTES
' ==============================================================================
actor "ğŸ‘¨â€ğŸ’¼ Jefatura\n(Juan PÃ©rez)" as jefe #E3F2FD
actor "ğŸ‘©â€ğŸ’¼ Director\n(MarÃ­a GonzÃ¡lez)" as director #F3E5F5
participant "ğŸ¨ Frontend\n(SvelteKit)" as frontend #FFF3E0
participant "âš™ï¸ Backend\n(Django API)" as backend #FFEBEE
participant "ğŸ” Validador\nJerarquÃ­a" as validador #E8F5E8
participant "ğŸ—„ï¸ Base de Datos\n(PostgreSQL)" as db #F0F4C3

' ==============================================================================
' CONFIGURACIÃ“N DE ESTILOS
' ==============================================================================
skinparam backgroundColor #FFFFFF
skinparam sequenceMessageAlign center
skinparam sequenceReferenceAlign center

' ==============================================================================
' FASE 1: JEFATURA PLANIFICA CRONOGRAMA
' ==============================================================================
group PlanificaciÃ³n por Jefatura

    jefe -> frontend : 1. Accede a "Crear Cronograma"
    note right of jefe
        **Rol: Jefatura**
        â€¢ Juan PÃ©rez (ID: 101)
        â€¢ Ãrea: Departamento Operativo
        â€¢ Permisos: Crear cronogramas
        â€¢ Requiere: AprobaciÃ³n superior
    end note
    
    frontend -> frontend : Cargar formulario de planificaciÃ³n
    note right of frontend
        **Interface de PlanificaciÃ³n:**
        â€¢ Selector de mes/aÃ±o
        â€¢ AsignaciÃ³n de agentes por dÃ­a
        â€¢ Horarios de guardia
        â€¢ Validaciones de disponibilidad
        â€¢ Vista previa del cronograma
    end note
    
    jefe -> frontend : 2. Completa planificaciÃ³n mensual
    note right of jefe
        **Datos del Cronograma:**
        â€¢ PerÃ­odo: Enero 2025
        â€¢ Tipo: "Cronograma Mensual"
        â€¢ 15 guardias asignadas
        â€¢ Agentes: 5 del departamento
        â€¢ Horarios: 08:00-16:00, 16:00-00:00
    end note
    
    frontend -> backend : POST /api/guardias/cronogramas/crear_con_guardias/
    note right of frontend
        **Request Payload:**
        {
          "tipo": "Cronograma Mensual",
          "id_area": 3,
          "periodo": "2025-01",
          "agente_id": 101,
          "guardias": [
            {"id_agente": 201, "fecha": "2025-01-01", "hora_inicio": "08:00", "hora_fin": "16:00"},
            {"id_agente": 202, "fecha": "2025-01-01", "hora_inicio": "16:00", "hora_fin": "00:00"},
            // ... mÃ¡s guardias
          ]
        }
    end note
    
    backend -> validador : get_agente_rol(agente_101)
    note right of validador
        **IdentificaciÃ³n de Rol:**
        SELECT r.nombre FROM rol r
        JOIN agente_rol ar ON r.id_rol = ar.id_rol
        WHERE ar.id_agente = 101
        
        **Resultado:** "Jefatura"
    end note
    
    validador --> backend : rol = "Jefatura"
    
    backend -> validador : determinar_estado_inicial("Jefatura")
    note right of validador
        **LÃ³gica JerÃ¡rquica:**
        if (rol == "Administrador"):
            return "publicada" // Auto-aprobado
        elif (rol == "Director"):
            return "pendiente" // Requiere Administrador
        elif (rol == "Jefatura"):
            return "pendiente" // Requiere Director
        else:
            return "pendiente" // Por defecto
    end note
    
    validador --> backend : estado_inicial = "pendiente"
    
    backend -> db : BEGIN TRANSACTION
    
    ' Crear cronograma con estado pendiente
    backend -> db : INSERT INTO cronograma
    note right of db
        **Cronograma Creado:**
        INSERT INTO cronograma (
          id_cronograma, tipo, id_area, id_jefe,
          estado, fecha_creacion,
          creado_por_rol, creado_por_id,
          aprobado_por_id, fecha_aprobacion
        ) VALUES (
          501, 'Cronograma Mensual', 3, 101,
          'pendiente', '2025-11-30',
          'jefatura', 101,
          NULL, NULL
        )
    end note
    
    db --> backend : cronograma_id = 501
    
    ' Crear guardias asociadas en estado pendiente
    backend -> db : INSERT INTO guardia (mÃºltiples guardias)
    note right of db
        **Guardias en Estado Pendiente:**
        INSERT INTO guardia (
          id_cronograma, id_agente, fecha,
          hora_inicio, hora_fin,
          estado, activa
        ) VALUES 
        (501, 201, '2025-01-01', '08:00', '16:00', 'pendiente_aprobacion', false),
        (501, 202, '2025-01-01', '16:00', '00:00', 'pendiente_aprobacion', false)
        // ... 13 guardias mÃ¡s
    end note
    
    db --> backend : guardias_creadas = 15
    
    ' Registrar auditorÃ­a de creaciÃ³n
    backend -> db : INSERT INTO auditoria
    note right of db
        **AuditorÃ­a CreaciÃ³n:**
        INSERT INTO auditoria (
          pk_afectada, nombre_tabla, accion,
          valor_nuevo, id_agente, creado_en
        ) VALUES (
          501, 'cronograma', 'CREAR_CRONOGRAMA',
          '{"guardias_count": 15, "periodo": "2025-01", "creado_por_rol": "jefatura"}',
          101, NOW()
        )
    end note
    
    backend -> db : COMMIT TRANSACTION
    
    backend --> frontend : HTTP 201 Created
    note right of backend
        **Response de CreaciÃ³n:**
        {
          "success": true,
          "cronograma_id": 501,
          "estado": "pendiente",
          "guardias_creadas": 15,
          "requiere_aprobacion": true,
          "mensaje": "Cronograma creado exitosamente. Pendiente de aprobaciÃ³n del Director."
        }
    end note
    
    frontend --> jefe : âœ… Cronograma creado - Pendiente de aprobaciÃ³n
    note right of jefe
        **NotificaciÃ³n a Jefatura:**
        "Cronograma de Enero 2025 creado exitosamente.
        Estado: Pendiente de aprobaciÃ³n
        Guardias: 15 asignadas (inactivas)
        PrÃ³ximo paso: Esperar aprobaciÃ³n del Director"
    end note

end

' ==============================================================================
' FASE 2: DIRECTOR CONSULTA CRONOGRAMAS PENDIENTES
' ==============================================================================
group Consulta de Pendientes por Director

    director -> frontend : 3. Accede a "Cronogramas Pendientes"
    note right of director
        **Rol: Director**
        â€¢ MarÃ­a GonzÃ¡lez (ID: 102)
        â€¢ Ãrea: DirecciÃ³n General
        â€¢ Permisos: Aprobar cronogramas de Jefatura
        â€¢ Vista: Solo cronogramas que puede aprobar
    end note
    
    frontend -> backend : GET /api/guardias/cronogramas/pendientes/?agente_id=102
    
    backend -> validador : get_agente_rol(agente_102)
    validador --> backend : rol = "Director"
    
    backend -> validador : filtrar_cronogramas_por_jerarquia("Director")
    note right of validador
        **Filtrado JerÃ¡rquico:**
        â€¢ Director puede aprobar: cronogramas de "Jefatura"
        â€¢ No puede aprobar: cronogramas de otros "Directores"
        â€¢ Administrador puede aprobar: TODOS los cronogramas
        
        **Query Filtrado:**
        WHERE creado_por_rol = 'jefatura' AND estado IN ('pendiente', 'generada')
    end note
    
    backend -> db : SELECT cronogramas con filtro jerÃ¡rquico
    note right of db
        **Query de Consulta:**
        SELECT c.*, 
               a_creador.nombre || ' ' || a_creador.apellido as creador_nombre,
               COUNT(g.id_guardia) as total_guardias
        FROM cronograma c
        JOIN agente a_creador ON c.creado_por_id = a_creador.id_agente
        LEFT JOIN guardia g ON c.id_cronograma = g.id_cronograma
        WHERE c.creado_por_rol = 'jefatura' 
          AND c.estado IN ('pendiente', 'generada')
        GROUP BY c.id_cronograma, a_creador.id_agente
        ORDER BY c.fecha_creacion ASC
    end note
    
    db --> backend : cronogramas_pendientes[]
    
    backend --> frontend : HTTP 200 + lista de cronogramas
    note right of backend
        **Response Cronogramas:**
        [
          {
            "id_cronograma": 501,
            "tipo": "Cronograma Mensual",
            "estado": "pendiente",
            "creado_por": "Juan PÃ©rez (Jefatura)",
            "fecha_creacion": "2025-11-30",
            "total_guardias": 15,
            "area": "Departamento Operativo",
            "puede_aprobar": true
          }
        ]
    end note
    
    frontend --> director : ğŸ“‹ Lista de cronogramas para aprobaciÃ³n
    note right of director
        **Vista Director:**
        Cronogramas Pendientes de AprobaciÃ³n
        
        ğŸ“… Cronograma #501 - Enero 2025
        ğŸ‘¤ Creado por: Juan PÃ©rez (Jefatura)  
        ğŸ¢ Ãrea: Departamento Operativo
        ğŸ“Š Guardias: 15 asignadas
        ğŸ“† Creado: 30/11/2025
        
        [ğŸŸ¢ Aprobar] [ğŸ”´ Rechazar] [ğŸ‘ï¸ Ver Detalle]
    end note

end

' ==============================================================================
' FASE 3A: DIRECTOR APRUEBA CRONOGRAMA
' ==============================================================================
group AprobaciÃ³n por Director (Flujo Exitoso)

    director -> frontend : 4a. Click "Aprobar Cronograma #501"
    
    frontend -> director : Modal de confirmaciÃ³n
    note right of frontend
        **ConfirmaciÃ³n de AprobaciÃ³n:**
        Â¿Confirmar aprobaciÃ³n del cronograma?
        
        â€¢ Cronograma: Enero 2025
        â€¢ Creado por: Juan PÃ©rez (Jefatura)
        â€¢ Guardias: 15 se activarÃ¡n
        â€¢ Ãrea: Departamento Operativo
        
        Observaciones: [campo opcional]
        [Confirmar AprobaciÃ³n] [Cancelar]
    end note
    
    director -> frontend : Confirma aprobaciÃ³n con observaciones
    
    frontend -> backend : PATCH /api/guardias/cronogramas/501/aprobar/
    note right of frontend
        **Request AprobaciÃ³n:**
        {
          "agente_id": 102,
          "observaciones": "Cronograma aprobado. DistribuciÃ³n equilibrada de guardias."
        }
    end note
    
    backend -> validador : verificar_permisos_aprobacion(cronograma_501, "Director")
    note right of validador
        **ValidaciÃ³n JerÃ¡rquica:**
        cronograma.creado_por_rol = "jefatura"
        aprobador.rol = "Director"
        
        roles_permitidos = get_approval_hierarchy("jefatura")
        // Retorna: ["director", "administrador"]
        
        âœ… "Director" estÃ¡ en roles_permitidos
    end note
    
    validador --> backend : permisos_validos = true
    
    backend -> db : BEGIN TRANSACTION
    
    ' Aprobar cronograma
    backend -> db : UPDATE cronograma (aprobar y publicar)
    note right of db
        **AprobaciÃ³n y PublicaciÃ³n:**
        UPDATE cronograma SET 
          estado = 'publicada',
          fecha_aprobacion = CURRENT_DATE,
          aprobado_por_id = 102
        WHERE id_cronograma = 501
    end note
    
    ' Activar guardias asociadas
    backend -> db : UPDATE guardia (activar todas)
    note right of db
        **ActivaciÃ³n de Guardias:**
        UPDATE guardia SET 
          estado = 'planificada',
          activa = true,
          actualizado_en = NOW()
        WHERE id_cronograma = 501
          AND estado = 'pendiente_aprobacion'
    end note
    
    db --> backend : guardias_activadas = 15
    
    ' AuditorÃ­a de aprobaciÃ³n
    backend -> db : INSERT INTO auditoria
    note right of db
        **AuditorÃ­a AprobaciÃ³n:**
        INSERT INTO auditoria (
          pk_afectada, nombre_tabla, accion,
          valor_previo, valor_nuevo, id_agente
        ) VALUES (
          501, 'cronograma', 'APROBAR_Y_PUBLICAR',
          '{"estado": "pendiente"}',
          '{"estado": "publicada", "guardias_activadas": 15, "aprobado_por": "MarÃ­a GonzÃ¡lez"}',
          102
        )
    end note
    
    backend -> db : COMMIT TRANSACTION
    
    backend --> frontend : HTTP 200 Success
    note right of backend
        **Response AprobaciÃ³n:**
        {
          "success": true,
          "mensaje": "Cronograma aprobado y publicado exitosamente",
          "cronograma_id": 501,
          "aprobado_por": "MarÃ­a GonzÃ¡lez",
          "fecha_aprobacion": "2025-11-30",
          "guardias_activadas": 15,
          "estado_final": "publicada"
        }
    end note
    
    frontend --> director : âœ… AprobaciÃ³n exitosa
    note right of director
        **ConfirmaciÃ³n a Director:**
        "Cronograma #501 aprobado exitosamente
        
        âœ… Estado: Publicado
        âœ… Guardias activadas: 15
        âœ… Visible para agentes
        âœ… Plus salarial calculable"
    end note

end

' ==============================================================================
' FASE 3B: DIRECTOR RECHAZA CRONOGRAMA  
' ==============================================================================
group Rechazo por Director (Flujo Alternativo)

    director -> frontend : 4b. Click "Rechazar Cronograma #501"
    
    frontend -> director : Modal de rechazo
    note right of frontend
        **Formulario de Rechazo:**
        Â¿Rechazar cronograma?
        
        Motivo del rechazo: [obligatorio]
        â€¢ â˜ DistribuciÃ³n desbalanceada
        â€¢ â˜ Conflictos de horarios
        â€¢ â˜ Agentes no disponibles
        â€¢ â˜ Otro: ___________
        
        Observaciones detalladas:
        [campo de texto obligatorio]
        
        [Confirmar Rechazo] [Cancelar]
    end note
    
    director -> frontend : Especifica motivo de rechazo
    
    frontend -> backend : POST /api/guardias/cronogramas/501/rechazar/
    note right of frontend
        **Request Rechazo:**
        {
          "agente_id": 102,
          "motivo_rechazo": "DistribuciÃ³n desbalanceada",
          "observaciones": "Algunos agentes tienen demasiadas guardias consecutivas. Revisar distribuciÃ³n en dÃ­as 15-20."
        }
    end note
    
    backend -> validador : verificar_permisos_rechazo(cronograma_501, "Director")
    validador --> backend : permisos_validos = true
    
    backend -> db : BEGIN TRANSACTION
    
    ' Rechazar cronograma
    backend -> db : UPDATE cronograma (rechazar)
    note right of db
        **Cambio a Estado Rechazado:**
        UPDATE cronograma SET 
          estado = 'rechazada',
          rechazado_por_id = 102,
          fecha_rechazo = CURRENT_DATE,
          motivo_rechazo = 'DistribuciÃ³n desbalanceada',
          observaciones_rechazo = 'Algunos agentes tienen demasiadas guardias...'
        WHERE id_cronograma = 501
    end note
    
    ' Las guardias permanecen inactivas
    backend -> db : UPDATE guardia (marcar como rechazadas)
    note right of db
        **Guardias Rechazadas:**
        UPDATE guardia SET 
          estado = 'rechazada',
          activa = false
        WHERE id_cronograma = 501
    end note
    
    ' AuditorÃ­a de rechazo
    backend -> db : INSERT INTO auditoria
    note right of db
        **AuditorÃ­a Rechazo:**
        INSERT INTO auditoria (
          pk_afectada, nombre_tabla, accion,
          valor_previo, valor_nuevo, id_agente
        ) VALUES (
          501, 'cronograma', 'RECHAZAR_CRONOGRAMA',
          '{"estado": "pendiente"}',
          '{"estado": "rechazada", "motivo": "DistribuciÃ³n desbalanceada", "rechazado_por": "MarÃ­a GonzÃ¡lez"}',
          102
        )
    end note
    
    backend -> db : COMMIT TRANSACTION
    
    backend --> frontend : HTTP 200 Success
    note right of backend
        **Response Rechazo:**
        {
          "success": true,
          "mensaje": "Cronograma rechazado",
          "cronograma_id": 501,
          "rechazado_por": "MarÃ­a GonzÃ¡lez",
          "motivo_rechazo": "DistribuciÃ³n desbalanceada",
          "estado_final": "rechazada"
        }
    end note
    
    frontend --> director : âœ… Cronograma rechazado
    
    ' NotificaciÃ³n automÃ¡tica a Jefatura
    backend -> frontend : NotificaciÃ³n push/email (futuro)
    note right of backend
        **NotificaciÃ³n a Jefatura:**
        "Su cronograma #501 ha sido rechazado
        
        Motivo: DistribuciÃ³n desbalanceada
        Comentarios: Algunos agentes tienen demasiadas guardias consecutivas...
        
        AcciÃ³n requerida: Revisar y crear nuevo cronograma"
    end note

end

' ==============================================================================
' JERARQUÃA Y REGLAS DE NEGOCIO
' ==============================================================================
note across
    **FLUJO DE TRABAJO JERÃRQUICO IMPLEMENTADO:**
    
    **ğŸ“‹ ROLES Y PERMISOS:**
    â€¢ ğŸ¢ **Jefatura:** Planifica cronogramas â†’ Estado "pendiente" 
    â€¢ ğŸ‘” **Director:** Aprueba/Rechaza cronogramas de Jefatura â†’ Estado "publicada"/"rechazada"
    â€¢ âš™ï¸ **Administrador:** Auto-aprobaciÃ³n â†’ Estado "publicada" directo
    
    **ğŸ”„ ESTADOS DEL CRONOGRAMA:**
    1. **"pendiente"** - Creado por Jefatura, esperando decisiÃ³n
    2. **"publicada"** - Aprobado por Director, guardias activas  
    3. **"rechazada"** - Rechazado por Director, vuelta a planificaciÃ³n
    
    **ğŸ›¡ï¸ VALIDACIONES JERÃRQUICAS:**
    âœ… Solo Director/Administrador pueden aprobar cronogramas de Jefatura
    âœ… Solo Administrador puede aprobar cronogramas de Director  
    âœ… ValidaciÃ³n de permisos en cada operaciÃ³n (get_agente_rol + puede_aprobar)
    âœ… AuditorÃ­a completa de cada transiciÃ³n de estado
    
    **âš¡ EFECTOS DE LA APROBACIÃ“N:**
    â€¢ Cronograma visible en calendarios de agentes
    â€¢ Guardias calculables para plus salarial
    â€¢ Estado inmutable (no editable despuÃ©s de publicaciÃ³n)
    â€¢ Reportes mensuales habilitados
    
    **ğŸ”„ EFECTOS DEL RECHAZO:**
    â€¢ Cronograma vuelve a estado "rechazada" 
    â€¢ Guardias permanecen inactivas
    â€¢ Jefatura debe revisar y crear nuevo cronograma
    â€¢ Historial de rechazo mantenido para auditorÃ­a
    
    **ğŸ“Š TRAZABILIDAD COMPLETA:**
    â€¢ Creador original (creado_por_id + creado_por_rol)
    â€¢ Aprobador (aprobado_por_id + fecha_aprobacion)
    â€¢ Rechazador (rechazado_por_id + motivo_rechazo)
    â€¢ AuditorÃ­a de todas las transiciones de estado
end note

@enduml