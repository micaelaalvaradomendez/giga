@startuml Flujo_Aprobacion_Guardias_Sistema_GIGA
!define SEQUENCE_DIAGRAM

title Sistema GIGA - Diagrama de Secuencia\nFlujo de AprobaciÃ³n de Guardias (CorazÃ³n del Negocio)\nJerarquÃ­a de Roles y Validaciones Implementadas

' ==============================================================================
' ACTORES Y PARTICIPANTES
' ==============================================================================
actor "ğŸ‘¨â€ğŸ’¼ Jefatura" as jefe #E3F2FD
actor "ğŸ‘©â€ğŸ’¼ Director" as director #F3E5F5
actor "âš™ï¸ Administrador" as admin #E8F5E8

participant "ğŸ¨ Frontend\n(SvelteKit)" as frontend #FFF3E0
participant "âš™ï¸ Backend\n(Django API)" as backend #FFEBEE
participant "ğŸ—„ï¸ Base de Datos\n(PostgreSQL)" as db #F0F4C3

' ==============================================================================
' CONFIGURACIÃ“N DE ESTILOS
' ==============================================================================
skinparam backgroundColor #FFFFFF
skinparam sequenceMessageAlign center
skinparam sequenceReferenceAlign center

' ==============================================================================
' FLUJO 1: JEFATURA CREA CRONOGRAMA
' ==============================================================================
group CreaciÃ³n de Cronograma por Jefatura
    
    jefe -> frontend : 1. Accede a "Crear Cronograma"
    note right of jefe
        **Datos del Cronograma:**
        â€¢ Tipo: "Mensual"
        â€¢ Ãrea: ID del Ã¡rea
        â€¢ Fecha: 2025-01-01
        â€¢ Hora inicio: 08:00
        â€¢ Hora fin: 16:00
        â€¢ Guardias: [agentes asignados]
    end note
    
    frontend -> backend : POST /api/guardias/cronogramas/crear_con_guardias/
    note right of frontend
        **Request Body:**
        {
          "tipo": "Mensual",
          "id_area": 3,
          "hora_inicio": "08:00",
          "hora_fin": "16:00",
          "fecha": "2025-01-01",
          "agente_id": 101,
          "guardias": [
            {"id_agente": 201, "fecha": "2025-01-01"},
            {"id_agente": 202, "fecha": "2025-01-02"}
          ]
        }
    end note
    
    backend -> backend : get_agente_rol(agente_creador)
    note right of backend
        **ValidaciÃ³n de Rol:**
        â€¢ Obtiene rol desde AgenteRol
        â€¢ Mapea: "jefe" â†’ "jefatura"
        â€¢ Determina permisos de creaciÃ³n
    end note
    
    backend -> backend : Determinar estado inicial
    note right of backend
        **LÃ³gica de Estado:**
        if (rol == 'administrador'):
            estado = 'publicada'
            aprobado_por = agente_id
        else:
            estado = 'pendiente'
            aprobado_por = null
    end note
    
    ' Validaciones del sistema
    alt Validaciones Exitosas
        
        backend -> backend : ValidadorHorarios.validar_fecha_guardia()
        note right of backend
            **Validaciones Implementadas:**
            1. âœ… Fecha no sea dÃ­a feriado
            2. âœ… Horarios no se solapen
            3. âœ… Agentes disponibles
            4. âœ… No exceder topes mensuales
        end note
        
        backend -> db : BEGIN TRANSACTION
        
        ' Crear cronograma
        backend -> db : INSERT INTO cronograma
        note right of db
            **Campos Cronograma:**
            â€¢ estado: 'pendiente'
            â€¢ creado_por_rol: 'jefatura'  
            â€¢ creado_por_id: 101
            â€¢ aprobado_por_id: null
            â€¢ fecha_aprobacion: null
            â€¢ id_jefe: 101
            â€¢ id_director: 101
        end note
        
        db --> backend : cronograma_id: 501
        
        ' Crear guardias asociadas
        backend -> db : INSERT INTO guardia (mÃºltiples)
        note right of db
            **Estado Guardias:**
            â€¢ estado: 'pendiente_aprobacion'
            â€¢ activa: false
            â€¢ id_cronograma: 501
            â€¢ horas_planificadas: calculadas
        end note
        
        db --> backend : guardias_ids: [601, 602]
        
        ' Registrar auditorÃ­a
        backend -> db : INSERT INTO auditoria
        note right of db
            **Registro AuditorÃ­a:**
            â€¢ accion: 'CREAR'
            â€¢ nombre_tabla: 'cronograma'
            â€¢ valor_nuevo: datos_cronograma
            â€¢ id_agente: 101
        end note
        
        backend -> db : COMMIT TRANSACTION
        
        backend --> frontend : HTTP 201 Created
        note right of backend
            **Response:**
            {
              "id_cronograma": 501,
              "estado": "pendiente",
              "requiere_aprobacion": true,
              "guardias_creadas": 2,
              "mensaje": "Cronograma creado, pendiente aprobaciÃ³n"
            }
        end note
        
        frontend --> jefe : âœ… "Cronograma creado exitosamente\nPendiente de aprobaciÃ³n del Director"
        
    else Validaciones Fallidas
        
        backend --> frontend : HTTP 400 Bad Request
        note right of backend
            **Errores Comunes:**
            â€¢ "Fecha no vÃ¡lida para guardia: Es feriado nacional"
            â€¢ "Agente no disponible en horario solicitado"
            â€¢ "Horarios se solapan con guardia existente"
        end note
        
        frontend --> jefe : âŒ Error: [mensaje especÃ­fico]
        
    end
    
end

' ==============================================================================
' FLUJO 2: DIRECTOR CONSULTA CRONOGRAMAS PENDIENTES
' ==============================================================================
group Consulta de Cronogramas Pendientes por Director

    director -> frontend : 2. Accede a "Cronogramas Pendientes"
    
    frontend -> backend : GET /api/guardias/cronogramas/pendientes/?agente_id=102
    note right of frontend
        **Filtros Aplicados:**
        â€¢ estado: 'pendiente' o 'generada'
        â€¢ puede_aprobar_rol: ['director', 'administrador']
    end note
    
    backend -> backend : puede_aprobar(cronograma, 'director')
    note right of backend
        **ValidaciÃ³n JerÃ¡rquica:**
        â€¢ Cronograma creado por 'jefatura'
        â€¢ Roles que pueden aprobar: ['director', 'administrador']  
        â€¢ Director tiene permisos: âœ… true
    end note
    
    backend -> db : SELECT cronogramas WHERE estado IN ('pendiente', 'generada')
    note right of db
        **Query SQL:**
        SELECT c.*, a.nombre, a.apellido 
        FROM cronograma c
        JOIN agente a ON c.creado_por_id = a.id_agente
        WHERE c.estado IN ('pendiente', 'generada')
        AND c.creado_por_rol = 'jefatura'
    end note
    
    db --> backend : cronogramas_pendientes[]
    
    backend --> frontend : HTTP 200 OK + cronogramas_data
    note right of backend
        **Response:**
        [
          {
            "id_cronograma": 501,
            "estado": "pendiente", 
            "creado_por": "Juan PÃ©rez (Jefatura)",
            "fecha_creacion": "2025-01-15",
            "guardias_count": 2,
            "puede_aprobar": true
          }
        ]
    end note
    
    frontend --> director : ğŸ“‹ Lista de cronogramas pendientes
    note right of director
        **Vista Director:**
        â€¢ Cronograma #501 - Enero 2025
        â€¢ Creado por: Juan PÃ©rez (Jefatura)
        â€¢ Estado: Pendiente aprobaciÃ³n
        â€¢ [BotÃ³n: Aprobar] [BotÃ³n: Rechazar]
    end note

end

' ==============================================================================
' FLUJO 3: DIRECTOR APRUEBA CRONOGRAMA
' ==============================================================================
group AprobaciÃ³n y PublicaciÃ³n por Director

    director -> frontend : 3. Click "Aprobar Cronograma #501"
    
    frontend -> backend : PATCH /api/guardias/cronogramas/501/aprobar/
    note right of frontend
        **Request Body:**
        {
          "agente_id": 102,
          "observaciones": "Aprobado segÃºn plan mensual"
        }
    end note
    
    ' Validaciones de aprobaciÃ³n
    backend -> backend : Validar estado actual
    alt Estado VÃ¡lido (pendiente/generada)
        
        backend -> backend : get_agente_rol(agente_aprobador)
        note right of backend
            **ValidaciÃ³n Rol Aprobador:**
            â€¢ Agente ID: 102
            â€¢ Rol encontrado: 'director'
            â€¢ Permisos: âœ… puede aprobar cronogramas de jefatura
        end note
        
        backend -> backend : puede_aprobar(cronograma, 'director')
        note right of backend
            **LÃ³gica de AprobaciÃ³n:**
            â€¢ Cronograma creado_por_rol: 'jefatura'
            â€¢ Director en roles permitidos: âœ… true
            â€¢ Administrador SIEMPRE puede aprobar: âœ…
        end note
        
        backend -> db : BEGIN TRANSACTION
        
        ' Aprobar y publicar cronograma
        backend -> db : UPDATE cronograma SET estado='publicada'
        note right of db
            **Cambios en Cronograma:**
            UPDATE cronograma SET 
              estado = 'publicada',
              fecha_aprobacion = CURRENT_DATE,
              aprobado_por_id = 102
            WHERE id_cronograma = 501
        end note
        
        ' Activar guardias asociadas
        backend -> db : UPDATE guardias SET activa=true, estado='planificada'
        note right of db
            **ActivaciÃ³n de Guardias:**
            UPDATE guardia SET 
              estado = 'planificada',
              activa = true
            WHERE id_cronograma = 501
            AND estado = 'pendiente_aprobacion'
        end note
        
        db --> backend : guardias_activadas: 2
        
        ' Registrar auditorÃ­a de aprobaciÃ³n
        backend -> db : INSERT INTO auditoria
        note right of db
            **AuditorÃ­a AprobaciÃ³n:**
            â€¢ accion: 'APROBAR_Y_PUBLICAR'
            â€¢ valor_previo: {'estado': 'pendiente'}
            â€¢ valor_nuevo: {'estado': 'publicada', 'guardias_activadas': 2}
            â€¢ id_agente: 102 (Director)
        end note
        
        backend -> db : COMMIT TRANSACTION
        
        backend --> frontend : HTTP 200 OK
        note right of backend
            **Response Exitosa:**
            {
              "mensaje": "Cronograma aprobado y publicado exitosamente",
              "cronograma_id": 501,
              "aprobado_por": "MarÃ­a GonzÃ¡lez (Director)",
              "fecha_aprobacion": "2025-01-16", 
              "guardias_activadas": 2,
              "estado_final": "publicada"
            }
        end note
        
        frontend --> director : âœ… "Cronograma #501 aprobado y publicado\n2 guardias activadas para los agentes"
        
        ' NotificaciÃ³n al Ã¡rea sobre cronograma publicado
        note across
            **EFECTOS DE LA PUBLICACIÃ“N:**
            âœ… Guardias visibles en calendario de agentes
            âœ… Plus salarial calculable para el mes
            âœ… Cronograma inmutable (no editable)
            âœ… Reportes mensuales disponibles
        end note
        
    else Estado InvÃ¡lido
        
        backend --> frontend : HTTP 400 Bad Request
        note right of backend
            **Error de Estado:**
            {
              "error": "Solo se pueden aprobar cronogramas en estado pendiente o generada",
              "estado_actual": "publicada"
            }
        end note
        
        frontend --> director : âŒ "Error: Cronograma ya fue procesado"
        
    end

end

' ==============================================================================
' FLUJO ALTERNATIVO: ADMINISTRADOR (AUTO-APROBACIÃ“N)
' ==============================================================================
group Flujo Administrador (Auto-aprobaciÃ³n)

    admin -> frontend : Crear Cronograma (como Administrador)
    frontend -> backend : POST /api/guardias/cronogramas/crear_con_guardias/
    
    backend -> backend : get_agente_rol() â†’ 'administrador'
    note right of backend
        **LÃ³gica Administrador:**
        if (rol == 'administrador'):
            estado_inicial = 'publicada'
            fecha_aprobacion = HOY
            aprobado_por_id = agente_id
            guardias_estado = 'planificada' 
            guardias_activas = true
    end note
    
    backend -> db : INSERT cronograma (estado='publicada')
    backend -> db : INSERT guardias (activa=true, estado='planificada')
    
    backend --> frontend : HTTP 201 - Cronograma publicado directamente
    frontend --> admin : âœ… "Cronograma creado y publicado automÃ¡ticamente"
    
    note right of admin
        **Privilegio Administrador:**
        â€¢ No requiere aprobaciÃ³n
        â€¢ Cronograma publicado inmediatamente  
        â€¢ Guardias activas desde creaciÃ³n
        â€¢ Puede aprobar cualquier cronograma
    end note

end

' ==============================================================================
' JERARQUÃA DE ROLES Y REGLAS DE NEGOCIO
' ==============================================================================
note across
    **JERARQUÃA DE APROBACIONES IMPLEMENTADA:**
    
    **ğŸ‘¨â€ğŸ’¼ Jefatura:**
    â€¢ Crea cronogramas â†’ estado 'pendiente'
    â€¢ Requiere aprobaciÃ³n de Director o Administrador
    â€¢ No puede auto-aprobar
    
    **ğŸ‘©â€ğŸ’¼ Director:**  
    â€¢ Puede aprobar cronogramas de Jefatura
    â€¢ Si crea cronograma â†’ requiere aprobaciÃ³n de Administrador
    â€¢ Acceso a cronogramas pendientes de su jerarquÃ­a
    
    **âš™ï¸ Administrador:**
    â€¢ Puede aprobar CUALQUIER cronograma
    â€¢ Sus cronogramas son auto-aprobados (publicados inmediatamente)
    â€¢ Acceso completo al sistema
    
    **REGLAS DE VALIDACIÃ“N:**
    âœ… Fechas no pueden ser feriados (tabla 'feriado')
    âœ… Agentes no pueden tener guardias solapadas
    âœ… ValidaciÃ³n de disponibilidad por horarios
    âœ… Registro completo de auditorÃ­a en cada operaciÃ³n
    âœ… Guardias solo se activan despuÃ©s de aprobaciÃ³n
    
    **ESTADOS DEL CRONOGRAMA:**
    â€¢ 'pendiente' â†’ Creado, esperando aprobaciÃ³n
    â€¢ 'publicada' â†’ Aprobado y visible para agentes
    â€¢ 'rechazada' â†’ Rechazado por superior jerÃ¡rquico
    
    **FLUJO DE DATOS:**
    CreaciÃ³n â†’ Validaciones â†’ Persistencia â†’ AprobaciÃ³n â†’ ActivaciÃ³n â†’ AuditorÃ­a
end note

@enduml