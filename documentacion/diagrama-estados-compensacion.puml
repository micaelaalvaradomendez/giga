@startuml Diagrama_Estados_Compensacion_GIGA
!define STATEDIAGRAM

title Sistema GIGA - Diagrama de Estados\nFlujo de CompensaciÃ³n de Horas Extra\nPendiente â†’ Aprobada/Rechazada

' ==============================================================================
' CONFIGURACIÃ“N DE ESTILOS
' ==============================================================================
skinparam backgroundColor #FFFFFF

skinparam state {
    BackgroundColor<<Pendiente>> #FFF3E0
    BorderColor<<Pendiente>> #F57C00
    
    BackgroundColor<<Aprobada>> #E8F5E8
    BorderColor<<Aprobada>> #4CAF50
    
    BackgroundColor<<Rechazada>> #FFEBEE
    BorderColor<<Rechazada>> #F44336
    
    BackgroundColor<<Final>> #E3F2FD
    BorderColor<<Final>> #2196F3
    
    FontSize 11
}

skinparam activity {
    BackgroundColor #F5F5F5
    BorderColor #9E9E9E
    FontSize 10
}

' ==============================================================================
' INICIO DEL FLUJO
' ==============================================================================
[*] --> CargaExceso : Jefatura detecta\nexceso horario

note right of CargaExceso
  **SituaciÃ³n Inicial:**
  â€¢ Guardia programada: 08:00-16:00 (8 horas)
  â€¢ Emergencia extendiÃ³ servicio hasta 20:00
  â€¢ Exceso: 4 horas extra por siniestro
  â€¢ Requiere justificaciÃ³n y aprobaciÃ³n
end note

' ==============================================================================
' ACCIÃ“N: JEFATURA CARGA EXCESO HORARIO
' ==============================================================================
CargaExceso : ğŸ‘¨â€ğŸ’¼ **JEFATURA CARGA**\n**EXCESO HORARIO**
CargaExceso : â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
CargaExceso : ğŸ“Š Datos del Servicio:
CargaExceso : â€¢ Agente: Juan PÃ©rez
CargaExceso : â€¢ Fecha: 15/01/2025
CargaExceso : â€¢ Programado: 08:00-16:00
CargaExceso : â€¢ Real: 08:00-20:00
CargaExceso : â€¢ Horas Extra: 4 horas
CargaExceso : â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
CargaExceso : ğŸ“ JustificaciÃ³n:
CargaExceso : â€¢ Motivo: Siniestro
CargaExceso : â€¢ DescripciÃ³n: Accidente ruta 3
CargaExceso : â€¢ NÂ° Acta: EXP-2025-001
CargaExceso : â€¢ Tipo: Plus adicional

note right of CargaExceso
  **Endpoint:** POST /api/guardias/compensaciones/crear/
  
  **Request Payload:**
  {
    "id_agente": 201,
    "id_guardia": 1501,
    "fecha_servicio": "2025-01-15",
    "hora_fin_real": "20:00:00",
    "motivo": "siniestro",
    "descripcion_motivo": "Accidente en ruta 3 requiriÃ³ extensiÃ³n del servicio",
    "numero_acta": "EXP-2025-001",
    "tipo_compensacion": "plus"
  }
end note

CargaExceso --> PENDIENTE : Sistema calcula\nhoras extra automÃ¡ticamente

' ==============================================================================
' ESTADO: PENDIENTE DE APROBACIÃ“N
' ==============================================================================
state PENDIENTE <<Pendiente>> {
  PENDIENTE : ğŸ”„ **COMPENSACIÃ“N PENDIENTE**
  PENDIENTE : â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  PENDIENTE : ğŸ“‹ Estado: "pendiente"
  PENDIENTE : ğŸ‘¤ Solicitado por: Jefatura
  PENDIENTE : ğŸ“… Fecha solicitud: 16/01/2025
  PENDIENTE : â° Horas extra: 4.0 horas
  PENDIENTE : ğŸ’° Monto estimado: $45,000
  PENDIENTE : â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  PENDIENTE : â³ Esperando revisiÃ³n del Director
  PENDIENTE : ğŸ“Š DÃ­as en estado: 2 dÃ­as
  PENDIENTE : ğŸš¨ Vencimiento: 28 dÃ­as restantes
}

note right of PENDIENTE
  **CaracterÃ­sticas del Estado:**
  â€¢ Creado automÃ¡ticamente al cargar exceso
  â€¢ Visible para Director en "Compensaciones Pendientes"
  â€¢ CÃ¡lculos automÃ¡ticos: horas_extra, monto_total
  â€¢ AuditorÃ­a: CREAR_COMPENSACION registrada
  â€¢ No afecta plus mensual hasta aprobaciÃ³n
  
  **Validaciones Activas:**
  â€¢ puede_aprobar() = true
  â€¢ esta_vencida() = false (< 30 dÃ­as)
  â€¢ estado = 'pendiente'
end note

' ==============================================================================
' DECISIÃ“N: DIRECTOR REVISA
' ==============================================================================
PENDIENTE --> DecisionDirector

state DecisionDirector <<choice>>
DecisionDirector : ğŸ’ **DIRECTOR REVISA**\nCompensaciÃ³n #1501

note right of DecisionDirector
  **Proceso de RevisiÃ³n:**
  â€¢ Director accede a lista de pendientes
  â€¢ Revisa documentaciÃ³n del siniestro
  â€¢ Verifica horas extra registradas
  â€¢ Consulta NÂ° Acta de emergencia
  â€¢ EvalÃºa si corresponde compensaciÃ³n
  
  **Criterios de EvaluaciÃ³n:**
  âœ… Emergencia real comprobada
  âœ… Exceso horario justificado
  âœ… DocumentaciÃ³n completa
  âœ… Agente disponible para extender servicio
  
  **Opciones Disponibles:**
  [ğŸŸ¢ Aprobar] [ğŸ”´ Rechazar] [ğŸ‘ï¸ Ver Detalle]
end note

' ==============================================================================
' FLUJO APROBACIÃ“N: APROBADA
' ==============================================================================
DecisionDirector --> APROBADA : [ğŸŸ¢ Aprueba]\nDirector confirma compensaciÃ³n
DecisionDirector --> RECHAZADA : [ğŸ”´ Rechaza]\nNo corresponde o falta documentaciÃ³n

state APROBADA <<Aprobada>> {
  APROBADA : âœ… **COMPENSACIÃ“N APROBADA**
  APROBADA : â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  APROBADA : ğŸ“‹ Estado: "aprobada"
  APROBADA : ğŸ‘” Aprobado por: MarÃ­a GonzÃ¡lez (Director)
  APROBADA : ğŸ“… Fecha aprobaciÃ³n: 18/01/2025
  APROBADA : ğŸ’° Monto aprobado: $45,000
  APROBADA : â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  APROBADA : âœ… Incluida en cÃ¡lculo de plus mensual
  APROBADA : ğŸ“Š Lista para liquidaciÃ³n
  APROBADA : ğŸ¯ Proceso completado exitosamente
}

note right of APROBADA
  **Efectos de la AprobaciÃ³n:**
  â€¢ Estado cambia a "aprobada"
  â€¢ aprobado_por_id = Director
  â€¢ fecha_aprobacion = timestamp actual
  â€¢ AuditorÃ­a: APROBAR_COMPENSACION
  
  **Impactos en el Sistema:**
  âœ… Se incluye en calcular_plus_simplificado()
  âœ… Suma a total_horas_completas mensual
  âœ… Puede elevar plus de 20% â†’ 40%
  âœ… Visible en reportes mensuales
  âœ… Lista para proceso de liquidaciÃ³n
end note

' ==============================================================================
' FLUJO RECHAZO: RECHAZADA
' ==============================================================================
state RECHAZADA <<Rechazada>> {
  RECHAZADA : âŒ **COMPENSACIÃ“N RECHAZADA**
  RECHAZADA : â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  RECHAZADA : ğŸ“‹ Estado: "rechazada"  
  RECHAZADA : ğŸ‘” Rechazado por: MarÃ­a GonzÃ¡lez (Director)
  RECHAZADA : ğŸ“… Fecha rechazo: 18/01/2025
  RECHAZADA : ğŸ“ Motivo: DocumentaciÃ³n incompleta
  RECHAZADA : â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  RECHAZADA : âŒ NO incluida en plus mensual
  RECHAZADA : ğŸ”„ Agente puede volver a solicitar
  RECHAZADA : ğŸ“Š Registrado para estadÃ­sticas
}

note right of RECHAZADA
  **Efectos del Rechazo:**
  â€¢ Estado cambia a "rechazada"
  â€¢ aprobado_por_id = Director (quien rechaza)
  â€¢ observaciones_aprobacion = motivo del rechazo
  â€¢ AuditorÃ­a: RECHAZAR_COMPENSACION
  
  **Impactos en el Sistema:**
  âŒ NO se incluye en cÃ¡lculo de plus
  âŒ NO suma a horas totales mensuales
  âŒ NO aparece en reportes de liquidaciÃ³n
  âœ… Mantiene historial para auditorÃ­a
  âœ… Agente puede solicitar nueva compensaciÃ³n con mejor documentaciÃ³n
end note

' ==============================================================================
' ESTADOS FINALES: LIQUIDACIÃ“N Y FRANCO
' ==============================================================================
APROBADA --> Liquidacion : Sistema procesa\npara pago mensual
APROBADA --> Franco : Agente solicita\nfranco compensatorio

state Liquidacion <<Final>> {
  Liquidacion : ğŸ’µ **LIQUIDACIÃ“N**
  Liquidacion : â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  Liquidacion : ğŸ“Š Incluida en plus mensual
  Liquidacion : ğŸ’° Monto: $45,000
  Liquidacion : ğŸ“… PerÃ­odo: Enero 2025
  Liquidacion : ğŸ§® CÃ¡lculo automÃ¡tico
}

state Franco <<Final>> {
  Franco : ğŸ–ï¸ **FRANCO COMPENSATORIO**
  Franco : â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  Franco : â° 4 horas = 0.5 dÃ­as franco
  Franco : ğŸ“… Fecha asignada: A coordinar
  Franco : ğŸ‘¥ Requiere cobertura de guardia
  Franco : ğŸ“‹ GestiÃ³n por RRHH
}

note bottom of Franco
  **Opciones de CompensaciÃ³n:**
  
  **1. Plus Adicional (automÃ¡tico):**
  â€¢ Se incluye en cÃ¡lculo mensual de plus
  â€¢ Impacta porcentaje 20% â†’ 40% si supera umbral
  â€¢ Pago junto con salario mensual
  
  **2. Franco Compensatorio (opcional):**
  â€¢ Agente puede solicitar dÃ­as de descanso
  â€¢ 8 horas extra = 1 dÃ­a de franco
  â€¢ Requiere coordinaciÃ³n con cronograma
  â€¢ GestiÃ³n manual por RRHH
  
  **3. Pago Directo (futuro):**
  â€¢ Pago independiente del salario base
  â€¢ Valor por hora segÃºn escalafÃ³n
  â€¢ LiquidaciÃ³n especial
end note

' ==============================================================================
' ESTADOS DE AUDITORÃA Y TRAZABILIDAD
' ==============================================================================
note as auditoria_completa
  **ğŸ” TRAZABILIDAD COMPLETA DEL FLUJO:**
  
  **Tabla: hora_compensacion**
  â€¢ id_hora_compensacion: PK Ãºnico
  â€¢ estado: 'pendiente' â†’ 'aprobada'/'rechazada'
  â€¢ solicitado_por_id: Jefatura que carga
  â€¢ aprobado_por_id: Director que decide
  â€¢ fecha_solicitud: timestamp creaciÃ³n
  â€¢ fecha_aprobacion: timestamp decisiÃ³n
  
  **Tabla: auditoria (registros automÃ¡ticos)**
  1. CREAR_COMPENSACION (al cargar exceso)
  2. APROBAR_COMPENSACION (al aprobar)
  3. RECHAZAR_COMPENSACION (al rechazar)
  
  **Impacto en Plus Mensual:**
  â€¢ funciÃ³n: calcular_plus_simplificado()
  â€¢ incluye: compensaciones con estado='aprobada'
  â€¢ suma: horas_extra al total mensual
  â€¢ puede elevar: plus de 20% a 40%
  
  **Reportes Disponibles:**
  â€¢ Compensaciones por agente/mes
  â€¢ Resumen de aprobaciones/rechazos
  â€¢ Impacto en plus mensual
  â€¢ EstadÃ­sticas de emergencias
end note

@enduml