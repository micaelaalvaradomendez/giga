@startuml Sistema_GIGA_Diagrama_Despliegue
!define RECTANGLE class

title Sistema GIGA - Diagrama de Despliegue (Arquitectura Docker)\nModularizaciÃ³n con Contenedores - ConfiguraciÃ³n Real del Proyecto

' ==============================================================================
' ESTILOS Y CONFIGURACIÃ“N
' ==============================================================================
skinparam backgroundColor #FFFFFF
skinparam handwritten false
skinparam monochrome false
skinparam shadowing false

skinparam node {
    BackgroundColor #E3F2FD
    BorderColor #1976D2
    FontSize 11
}

skinparam component {
    BackgroundColor #F3E5F5
    BorderColor #7B1FA2
    FontSize 10
}

skinparam database {
    BackgroundColor #E8F5E8
    BorderColor #388E3C
    FontSize 10
}

skinparam artifact {
    BackgroundColor #FFF3E0
    BorderColor #F57C00
    FontSize 10
}

skinparam cloud {
    BackgroundColor #FFEBEE
    BorderColor #D32F2F
    FontSize 10
}

' ==============================================================================
' NODO PRINCIPAL - SERVIDOR/HOST
' ==============================================================================
node "ðŸ–¥ï¸ Servidor Host (Docker Engine)" as host_server {
    
    ' ------------------------------------------------------------------------------
    ' NGINX REVERSE PROXY (PUNTO DE ENTRADA)
    ' ------------------------------------------------------------------------------
    component "ðŸŒ NGINX Gateway" as nginx_container #FFE0B2 {
        artifact "nginx.conf" as nginx_conf
        artifact "Health Check" as nginx_health
        artifact "Static Files" as nginx_static
        
        note right of nginx_container
            **Container:** giga-nginx
            **Puertos Expuestos:**
            â€¢ 80:80 (HTTP Principal)
            â€¢ 8080:8080 (Monitoreo)
            
            **Upstreams:**
            â€¢ giga_frontend:3000
            â€¢ giga_backend:8000
            
            **Rutas:**
            â€¢ / â†’ Frontend (SvelteKit)
            â€¢ /api/ â†’ Backend (Django)
            â€¢ /admin/ â†’ Django Admin
            â€¢ /static/ â†’ Static Files
            â€¢ /media/ â†’ Media Files
            â€¢ /api/n8n/ â†’ n8n Workflows
        end note
    }
    
    ' ------------------------------------------------------------------------------
    ' FRONTEND SVELTEKIT
    ' ------------------------------------------------------------------------------
    component "ðŸŽ¨ Frontend SvelteKit" as frontend_container #E1F5FE {
        artifact "Vite Dev Server" as vite_server
        artifact "HMR WebSocket" as hmr_ws
        artifact "Proxy Config" as vite_proxy
        
        note right of frontend_container
            **Container:** giga-frontend
            **Puerto Interno:** 3000:3000
            **Framework:** SvelteKit 2.47.1
            **Build Tool:** Vite 7.1.10
            
            **CaracterÃ­sticas:**
            â€¢ Hot Module Reload (HMR)
            â€¢ WebSocket support
            â€¢ Proxy interno a backend
            â€¢ File watcher con polling
            
            **Dependencias:**
            â€¢ Depends on: backend (healthy)
            â€¢ Health check via curl
        end note
    }
    
    ' ------------------------------------------------------------------------------
    ' BACKEND DJANGO
    ' ------------------------------------------------------------------------------
    component "âš™ï¸ Backend Django" as backend_container #F3E5F5 {
        artifact "Django 4.2+" as django_app
        artifact "REST API" as rest_api
        artifact "Admin Interface" as django_admin
        artifact "Static Handler" as static_handler
        
        note right of backend_container
            **Container:** giga-django
            **Puerto Interno:** 8000:8000
            **Framework:** Django 4.2+
            **WSGI Server:** Gunicorn
            
            **APIs Expuestas:**
            â€¢ /api/personas/ (Usuarios)
            â€¢ /api/guardias/ (Cronogramas)
            â€¢ /api/asistencia/ (Marcaciones)
            â€¢ /api/auditoria/ (Logs)
            â€¢ /admin/ (Django Admin)
            
            **Dependencias:**
            â€¢ Depends on: postgres (healthy)
            â€¢ Health check: manage.py check
        end note
    }
    
    ' ------------------------------------------------------------------------------
    ' BASE DE DATOS POSTGRESQL
    ' ------------------------------------------------------------------------------
    database "ðŸ—„ï¸ PostgreSQL 16" as postgres_container #E8F5E8 {
        artifact "giga Database" as giga_db
        artifact "Init Scripts" as init_scripts
        artifact "Health Monitor" as pg_health
        
        note right of postgres_container
            **Container:** giga-postgres
            **Puerto Expuesto:** 5432:5432
            **Image:** postgres:16-alpine
            **Database:** giga
            **User:** giga_user
            
            **VolÃºmenes:**
            â€¢ postgres_data:/var/lib/postgresql/data
            â€¢ ./bd/init-scripts:/docker-entrypoint-initdb.d
            
            **ConfiguraciÃ³n:**
            â€¢ PGDATA personalizado
            â€¢ Scripts de inicializaciÃ³n automÃ¡tica
            â€¢ Health check: pg_isready
        end note
    }
    
    ' ------------------------------------------------------------------------------
    ' MINIO OBJECT STORAGE
    ' ------------------------------------------------------------------------------
    cloud "ðŸ’¾ MinIO Storage" as minio_container #FFF8E1 {
        artifact "S3 API" as minio_s3
        artifact "Web Console" as minio_console
        artifact "convenio Bucket" as minio_bucket
        
        note right of minio_container
            **Container:** giga-minio
            **Puertos Expuestos:**
            â€¢ 9000:9000 (API S3)
            â€¢ 9090:9090 (Console)
            
            **Image:** minio/minio:latest
            **Command:** server /data --console-address ":9090"
            
            **Credentials:**
            â€¢ Root: giga-user / giga-password-change-me
            
            **Volumen:**
            â€¢ minio_data:/data
        end note
    }
    
    ' ------------------------------------------------------------------------------
    ' N8N WORKFLOW ENGINE
    ' ------------------------------------------------------------------------------
    cloud "ðŸ¤– n8n Workflows" as n8n_container #FFEBEE {
        artifact "Workflow Engine" as n8n_engine
        artifact "Webhook Handler" as n8n_webhook
        artifact "LLM Integration" as n8n_llm
        
        note right of n8n_container
            **Container:** giga-n8n
            **Puerto Expuesto:** 5678:5678
            **Image:** n8nio/n8n:latest
            
            **ConfiguraciÃ³n:**
            â€¢ N8N_HOST=localhost
            â€¢ N8N_PORT=5678
            â€¢ WEBHOOK_URL=http://localhost:5678/
            â€¢ TZ=America/Argentina/Buenos_Aires
            â€¢ N8N_BASIC_AUTH_ACTIVE=false
            
            **Dependencias:**
            â€¢ Depends on: minio
            
            **Volumen:**
            â€¢ n8n_data:/home/node/.n8n
        end note
    }
    
    ' ------------------------------------------------------------------------------
    ' RED DOCKER INTERNA
    ' ------------------------------------------------------------------------------
    component "ðŸ”— giga-network" as docker_network #F5F5F5 {
        note bottom of docker_network
            **Tipo:** bridge
            **Nombre:** giga-network
            **Driver:** local
            
            **ComunicaciÃ³n Interna:**
            â€¢ Todos los servicios conectados
            â€¢ ResoluciÃ³n DNS por nombre de container
            â€¢ Aislamiento de red completo
        end note
    }
    
    ' ------------------------------------------------------------------------------
    ' VOLÃšMENES PERSISTENTES
    ' ------------------------------------------------------------------------------
    artifact "ðŸ“¦ VolÃºmenes Docker" as docker_volumes #F0F0F0 {
        note bottom of docker_volumes
            **VolÃºmenes Persistentes:**
            â€¢ postgres_data (BD)
            â€¢ static_volume (archivos estÃ¡ticos)
            â€¢ media_volume (archivos media)
            â€¢ frontend_node_modules (deps NPM)
            â€¢ minio_data (storage S3)
            â€¢ n8n_data (workflows)
            
            **Driver:** local
            **UbicaciÃ³n:** /var/lib/docker/volumes/
        end note
    }
}

' ==============================================================================
' USUARIO EXTERNO
' ==============================================================================
actor "ðŸ‘¤ Usuario" as user

' ==============================================================================
' FLUJOS DE COMUNICACIÃ“N PRINCIPALES
' ==============================================================================

' FLUJO 1: Usuario accede al sistema
user -right-> nginx_container : "HTTP Request\n**:80**"
note on link : Puerto Principal\nPunto de Entrada

' FLUJO 2: NGINX enruta al Frontend
nginx_container -down-> frontend_container : "Proxy /\n**:3000**"
note on link : SvelteKit App\nHMR WebSocket

' FLUJO 3: NGINX enruta al Backend
nginx_container -down-> backend_container : "Proxy /api/\n**:8000**"
note on link : Django REST API\nAdmin Interface

' FLUJO 4: NGINX enruta a n8n
nginx_container -right-> n8n_container : "Proxy /api/n8n/\n**:5678**"
note on link : Webhooks IA\nWorkflow Engine

' FLUJO 5: Backend conecta a BD
backend_container -down-> postgres_container : "Django ORM\npsycopg2\n**:5432**"
note on link : Database First\nPostgreSQL 16

' FLUJO 6: n8n conecta a MinIO
n8n_container -down-> minio_container : "S3 API\n**:9000**"
note on link : convenio.pdf\nDocument Storage

' FLUJO 7: Frontend proxy directo (desarrollo)
frontend_container ..> backend_container : "Vite Proxy\n/api, /admin, /static"
note on link : Desarrollo\nProxy Interno

' FLUJO 8: Red Docker interna
nginx_container -.-> docker_network
frontend_container -.-> docker_network
backend_container -.-> docker_network
postgres_container -.-> docker_network
minio_container -.-> docker_network
n8n_container -.-> docker_network

' FLUJO 9: VolÃºmenes persistentes
postgres_container -.-> docker_volumes : "postgres_data"
backend_container -.-> docker_volumes : "static_volume\nmedia_volume"
frontend_container -.-> docker_volumes : "node_modules"
minio_container -.-> docker_volumes : "minio_data"
n8n_container -.-> docker_volumes : "n8n_data"

' ==============================================================================
' PUERTOS Y CONFIGURACIÃ“N DETALLADA
' ==============================================================================

note as puertos_config
    **CONFIGURACIÃ“N DE PUERTOS REAL:**
    
    **Puertos Expuestos al Host:**
    â€¢ 80:80 â†’ NGINX (Punto de entrada principal)
    â€¢ 8080:8080 â†’ NGINX (Monitoreo y status)
    â€¢ 3000:3000 â†’ Frontend (Desarrollo directo)
    â€¢ 8000:8000 â†’ Backend (Desarrollo directo)
    â€¢ 5432:5432 â†’ PostgreSQL (Acceso externo BD)
    â€¢ 9000:9000 â†’ MinIO API (S3 compatible)
    â€¢ 9090:9090 â†’ MinIO Console (Web UI)
    â€¢ 5678:5678 â†’ n8n (Workflow management)
    
    **ComunicaciÃ³n Interna (Docker Network):**
    â€¢ giga-frontend:3000
    â€¢ giga-django:8000
    â€¢ giga-postgres:5432
    â€¢ giga-minio:9000
    â€¢ giga-n8n:5678
    
    **Health Checks Configurados:**
    âœ… PostgreSQL: pg_isready
    âœ… Django: manage.py check --database
    âœ… Frontend: curl localhost:3000
    âœ… NGINX: custom healthcheck script
    âœ… MinIO: curl health endpoint
end note

' ==============================================================================
' JUSTIFICACIÃ“N MODULARIZACIÃ“N
' ==============================================================================

note as modularizacion
    **JUSTIFICACIÃ“N DE MODULARIZACIÃ“N:**
    
    **âœ… SeparaciÃ³n de Responsabilidades:**
    â€¢ Frontend: UI/UX (SvelteKit + Vite)
    â€¢ Backend: API + LÃ³gica de negocio (Django)
    â€¢ Base de Datos: Persistencia (PostgreSQL)
    â€¢ Proxy: Routing + Load balancing (NGINX)
    â€¢ Storage: Archivos + Documentos (MinIO)
    â€¢ Automation: Workflows + IA (n8n)
    
    **âœ… Escalabilidad Independiente:**
    â€¢ Cada servicio puede escalar por separado
    â€¢ Recursos asignados especÃ­ficamente
    â€¢ Health checks individuales
    
    **âœ… Desarrollo Independiente:**
    â€¢ Equipos pueden trabajar en paralelo
    â€¢ TecnologÃ­as especÃ­ficas por mÃ³dulo
    â€¢ Deploy independiente de cada servicio
    
    **âœ… Mantenimiento Simplificado:**
    â€¢ Actualizaciones sin afectar otros servicios
    â€¢ Rollback selectivo por componente
    â€¢ Monitoreo granular
    
    **âœ… ReutilizaciÃ³n:**
    â€¢ Servicios pueden ser consumidos por otros sistemas
    â€¢ APIs bien definidas entre componentes
    â€¢ ConfiguraciÃ³n via variables de entorno
end note

@enduml